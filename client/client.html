<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Olivieri Project 1</title>
    <link rel="stylesheet" type="text/css" href="/style.css">

    <script src="../src/client-header.js" type="text"></script>


    <script>

        const handleResponse = async (response, pResponse) => {
            const content = document.querySelector('#content');

            // Switch based on the response status code
            switch (response.status) {
                case 200:
                    content.innerHTML = '<b>Success!</b>';
                    break;
                case 201:
                    content.innerHTML = '<b>Created</b>';
                    break;
                case 400:
                    content.innerHTML = '<b>Bad Request ):</b>';
                    break;
                case 404:
                    content.innerHTML = '<b>Resource Not Found</b>';
                default:
                    content.innerHTML = '<b>Something went wrong ):</b>';
                    break;
            }

            if (pResponse) {
                // parse the JSON
                const obj = await response.json();

                console.log(obj.users);

                const jsonString = JSON.stringify(obj.users);

                content.innerHTML += `<p>${jsonString}</p>`;

                // If we have a message, display it.
                // if (obj.message) {
                // content.innerHTML += `<p>${obj.message}</p>`;
                // }
            } else {
                // content.innerHTML += '<p>Meta Data Received</p>';
            }
        };

        // Uses fetch to send a post Request

        const sendPost = async (nameForm) => {
            // Grab info from the form
            const nameAction = nameForm.getAttribute('action');
            const nameMethod = nameForm.getAttribute('method');

            // name and position of the baseball player we want to add
            const nameField = nameForm.querySelector('#nameField');
            const positionField = nameForm.querySelector('#positionField');

            // Build a data string in the FORM-URLENCODED format.
            const formData = `name=${nameField.value}&pos=${positionField.value}`;

            // Make a fetch request
            const response = await fetch(nameAction, {
                method: nameMethod,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    Accept: 'application/json',
                },
                body: formData,
            });

            handleResponse(response);
        };// end send post

        const requestUpdate = async (userForm) => {
            // Grab the url and method from the html form below
            const url = userForm.querySelector('#urlField').value;

            // Await our fetch response.
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    Accept: 'application/json',
                },
            });

            handleResponse(response, true);
        };

        const init = () => {
            // Grab the form
            const nameForm = document.querySelector('#nameForm');
            const userForm = document.querySelector('#userForm');

            // Create an addUser fns
            const addUser = (e) => {
                e.preventDefault();
                sendPost(nameForm);
                return false;
            };

            // Create getUser fns
            const getUsers = (e) => {
                e.preventDefault();
                requestUpdate(userForm);
                return false;
            };

            // Call addUser when the submit event fires on the name form.
            nameForm.addEventListener('submit', addUser);
            userForm.addEventListener('submit', getUsers);
        };

        window.onload = init;








        //Header styling 

        const template = document.createElement("template");
        template.innerHTML = `
    <style>
header{
    color: white;
    background-color: green;
    padding: 1em;
    user-select: none;
    margin-bottom: .5rem;
  }
  header h1{
    font-family: sans-serif;
    letter-spacing: 1px;
  }
  
  header span{
    font-variant: small-caps;
    font-weight: bolder;
    font-family: sans-serif;
    font-style: italic;
  }
    </style>
<header>
    <h1>Starting Basball Lineup</h1>
    <span>Set your starting team!</span>
</header>
`;

        class ClientHeader extends HTMLElement {
            constructor() {
                super();

                //attach shadow DOM
                this.attachShadow({ mode: "open" });

                //clone template
                this.shadowRoot.appendChild(template.content.cloneNode(true));

                this.h1 = this.shadowRoot.querySelector("h1");
                this.span = this.shadowRoot.querySelector("span");

            }//end constructor


            connectedCallback() {
                this.render();
            }

            disconnectedCallback() {
                //cleanup
                this.onclick = null;
            }

            attributeChangedCallback(attributeName, oldVal, newVal) {
                ///console.log(attributeName, oldVal, newVal);
                this.render();
            }

            static get observedAttributes() {
                return ["data-title"];
            }

            render() {
                //grab attribute vals and assign default val if needed
                const title = this.dataset.title ? this.dataset.title : "Star Wars";
                this.h1.innerHTML = `${title}`;
                this.span.innerHTML = `Set your starting team!`;
            }

        }//ends SWHeader element

        customElements.define('client-header', ClientHeader);


    </script>
</head>

<body>
    <client-header data-title="Baseball Lineup Generator"></client-header>

    <section id="top">

        <form id="nameForm" action="/addUser" method="post">
            <label for="name">Name: </label>
            <input id="nameField" type="text" name="name" />
            <label for="position">Position: </label>
            <input id="positionField" type="number" name="position" min="1" max="9" step="1" />
            <input type="submit" value="Add Player" />
        </form>
        <form id="userForm" action="/getUsers" method="get">
            <select id='urlField'>
                <option value='/getUsers'>Get Lineup</option>
            </select>
            <input type="submit" value="Get User" />
        </form>
    </section>
    <section id="content">
    </section>
</body>

</html>